<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MatrÃ­cula de Materias</title>
  <style>
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      cursor: pointer;
    }
    .curso-header { font-weight: bold; }
    .curso-info { margin-top: 8px; display: none; }
    .card.expanded .curso-info { display: block; }
    .grupo { margin-top: 8px; }
    .btn-prematricular {
      margin-top: 5px;
      padding: 5px 10px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-prematricular:disabled {
      background: gray;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>MatrÃ­cula de Materias</h1>
  <div id="lista-cursos"></div>
  
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const carreraId = Number(urlParams.get('carrera'));

    if (!carreraId) {
      document.getElementById("lista-cursos").innerHTML = "<p>No se ha seleccionado ninguna carrera.</p>";
    } else {
      // Llamada al backend usando carreraId
      fetch(`http://localhost:3000/materias/${carreraId}`)
        .then(res => res.json())
        .then(materias => {
  console.log("Respuesta del backend:", materias); // ðŸ‘€
  if (!materias.length) {
    document.getElementById("lista-cursos").innerHTML = "<p>No hay materias disponibles para esta carrera.</p>";
    return;
  }

          materias.forEach(m => {
            const lista = document.getElementById("lista-cursos");
            const card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
              <div class="curso-header">${m.Id_Materia} - ${m.Nom_Materia}</div>
              <div class="curso-info">
                <div><b>Requisito:</b> ${m.Requisito || "Ninguno"}</div>
                <div><b>CrÃ©ditos:</b> ${m.Creditos}</div>
                <div><b>Cupos:</b> ${m.Cupos}</div>
              </div>
              <div class="grupos">
                <div class="grupo">
                  <strong>Grupo Ãºnico</strong><br>
                  Cupo: ${m.Cupos} <br>
                  <button class="btn-prematricular">Prematricular</button>
                </div>
              </div>
            `;

            card.addEventListener("click", () => card.classList.toggle("expanded"));

            const btn = card.querySelector(".btn-prematricular");
            btn.addEventListener("click", async e => {
              e.stopPropagation();
              const resp = await fetch("http://localhost:3000/prematricular", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ idMateria: m.Id_Materia })
              });
              const data = await resp.json();
              if (resp.ok) {
                btn.disabled = true;
                btn.textContent = "Prematriculado";
              } else {
                alert(data.error || "Error al prematricular");
              }
            });

            lista.appendChild(card);
          });
        })
        .catch(err => {
          console.error("Error al cargar materias:", err);
          document.getElementById("lista-cursos").innerHTML = "<p>Error al cargar materias.</p>";
        });
    }
  </script>
</body>
</html>
