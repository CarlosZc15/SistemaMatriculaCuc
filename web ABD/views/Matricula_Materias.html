<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Matr√≠cula de Materias</title>
  <style>
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      cursor: pointer;
    }
    .curso-header { font-weight: bold; }
    .curso-info { margin-top: 8px; display: none; }
    .card.expanded .curso-info { display: block; }
    .grupo { margin-top: 8px; }
    .btn-prematricular {
      margin-top: 5px;
      padding: 5px 10px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-prematricular:disabled {
      background: gray;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Matr√≠cula de Materias</h1>
  <div id="lista-cursos">Cargando materias...</div>
  
  <script>
    async function cargarMateriasPorCarrera() {
      const carreraId = localStorage.getItem("carreraSeleccionada");
      const usuario = JSON.parse(localStorage.getItem("usuario")); // üëà carnet viene de login
      const contenedor = document.getElementById("lista-cursos");

      if (!carreraId) {
        alert("Debe seleccionar una carrera primero");
        window.location.href = "Parametros_Matricula.html";
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/materias/${carreraId}`);
        if (!res.ok) throw new Error("Respuesta no OK: " + res.status);

        const materias = await res.json();
        console.log("Materias recibidas:", materias);

        if (!Array.isArray(materias) || materias.length === 0) {
          contenedor.innerHTML = "<p>No hay materias registradas para esta carrera.</p>";
          return;
        }

        contenedor.innerHTML = "";
        materias.forEach(m => {
          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
            <div class="curso-header">${m.Id_Materia} - ${m.Nom_Materia}</div>
            <div class="curso-info">
              <div><b>Requisito:</b> ${m.Requisito || "Ninguno"}</div>
              <div><b>Cr√©ditos:</b> ${m.Creditos}</div>
              <div><b>Cupos:</b> ${m.Cupos}</div>
            </div>
            <div class="grupos">
              <div class="grupo">
                <strong>Grupo √∫nico</strong><br>
                Cupo: ${m.Cupos} <br>
                <button class="btn-prematricular" data-id="${m.Id_Materia}">Prematricular</button>
              </div>
            </div>
          `;

          // Expandir card al hacer click
          card.querySelector(".curso-header").addEventListener("click", () => {
            card.classList.toggle("expanded");
          });

          // Acci√≥n de prematricular
          const btn = card.querySelector(".btn-prematricular");
          btn.addEventListener("click", async (e) => {
            e.stopPropagation(); // evita abrir/cerrar card al presionar bot√≥n

            if (!usuario) {
              alert("Debe iniciar sesi√≥n primero");
              return;
            }

            try {
              const res = await fetch("http://localhost:3000/prematricular", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  carnet: usuario.carnet,
                  idMateria: m.Id_Materia,
                  idCarrera: carreraId
                })
              });

              const data = await res.json();
              if (res.ok) {
                alert("‚úÖ Prematr√≠cula realizada con √©xito");
                btn.disabled = true;
                btn.textContent = "Prematriculada";
              } else {
                alert("‚ùå Error: " + (data.message || "No se pudo prematricular"));
              }
            } catch (err) {
              console.error("Error en prematricula:", err);
              alert("Error en la conexi√≥n al servidor");
            }
          });

          contenedor.appendChild(card);
        });
      } catch (err) {
        console.error("Error al cargar materias:", err);
        contenedor.innerHTML = "<p>Error al cargar materias. Revisa la consola.</p>";
      }
    }

    // Ejecutar al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", cargarMateriasPorCarrera);
  </script>
</body>
</html>
